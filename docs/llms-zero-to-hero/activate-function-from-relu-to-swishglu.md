---
title: LLM activate functionæ¿€æ´»å‡½æ•°çš„è¿›åŒ–ä¹‹è·¯ï¼Œä» ReLUï¼ŒGELU åˆ° swishGLU
date: 2025-01-27T18:58:00
star: true
tag:
  - transformer
  - LLM
category:
  - hands-on-code
  - llms-zero-to-hero
description: "ä¸»è¦ä»‹ç»äº†ä»åŸºç¡€çš„ ReLU åˆ° GELUï¼Œå†åˆ°ç°ä»£å¤§è¯­è¨€æ¨¡å‹ä¸­å¹¿æ³›ä½¿ç”¨çš„ SwishGLU çš„å‘å±•è¿‡ç¨‹, ä»‹ç»äº†æ·±åº¦å­¦ä¹ ä¸­æ¿€æ´»å‡½æ•°æ¼”è¿›å†ç¨‹ã€‚æ–‡ç« è¯¦ç»†è®²è§£äº†å„ä¸ªæ¿€æ´»å‡½æ•°çš„æ•°å­¦åŸç†å’Œå®ç°æ–¹å¼ï¼Œå¹¶é‡ç‚¹åˆ†æäº† SwishGLU å¦‚ä½•ç»“åˆ Swish æ¿€æ´»å‡½æ•°å’Œ GLU é—¨æ§å•å…ƒçš„ä¼˜ç‚¹ã€‚åŒæ—¶ï¼Œæ–‡ç« è¿˜æä¾›äº†å®Œæ•´çš„ PyTorch ä»£ç å®ç°ï¼Œå±•ç¤ºäº†å¦‚ä½•åœ¨ç¥ç»ç½‘ç»œä¸­ä½¿ç”¨è¿™äº›æ¿€æ´»å‡½æ•°ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤§è¯­è¨€æ¨¡å‹çš„ FFNï¼ˆå‰é¦ˆç¥ç»ç½‘ç»œï¼‰å±‚ä¸­çš„åº”ç”¨ã€‚å¯¹äºæƒ³è¦æ·±å…¥ç†è§£ç°ä»£æ·±åº¦å­¦ä¹ æ¨¡å‹æ¶æ„çš„å¼€å‘è€…å’Œç ”ç©¶è€…æ¥è¯´ï¼Œè¿™æ˜¯ä¸€ä»½å¾ˆæœ‰ä»·å€¼çš„å‚è€ƒèµ„æ–™ã€‚"
publish: true
permalink: /llms-zero-to-hero/activate-function-from-relu-gelu-to-swishglu.html
banner: https://bruceyuan.com/img/huggingface.png
---

## 1. èƒŒæ™¯
è‡ª chatGPT 22å¹´åº•é—®ä¸–ä»¥æ¥ï¼Œå¤§æ¨¡å‹ï¼ˆLarge Language Model, LLMï¼‰ä¸€èˆ¬ä½¿ç”¨ [Causal Language Model](https://bruceyuan.com/hands-on-code/hands-on-causallm-decoder.html) çš„å½¢å¼ï¼Œå±äº Transformers ä¸­çš„ Decoder éƒ¨åˆ†ï¼Œå…¶ä¸­åœ¨ Decoder çš„ Block ä¸­æœ‰ä¸€ä¸ª FFN(FeadForward) å±‚ï¼Œä¸€èˆ¬è®¤ä¸ºè¿™éƒ¨åˆ†å‚æ•°ç”¨äºå­˜å‚¨çŸ¥è¯†ã€‚è€Œæ ‡å‡†çš„ FFN ä¸€èˆ¬æœ‰ä¸€ä¸ªå‡ç»´åº¦å’Œé™ç»´åº¦çš„è¿‡ç¨‹ï¼Œä¸€å…±æœ‰ä¸¤ä¸ªæƒé‡çŸ©é˜µï¼Œç”¨å…¬å¼è¡¨ç¤ºä¸º

$$FFN(x) = ReLU(xW_1 + b1)W2 + b2  \tag{1}$$

å…¶ä¸­ x shape æ˜¯ $(b, s, h)$ï¼Œw1 shape æ˜¯ $(h, 4h)$ï¼Œw2 shape æ˜¯ $(4h, h)$, w1 æ˜¯å‡ç»´ï¼ˆupï¼‰ï¼Œw2 æ˜¯é™ç»´(down)

æ¿€æ´»å‡½æ•°ä¸»è¦æ˜¯ä¸ºäº†å®ç°ç¥ç»ç½‘ç»œå­¦ä¹ è¾“å…¥å’Œè¾“å‡ºä¹‹é—´çš„å¤æ‚éçº¿æ€§å…³ç³»è€Œä½¿ç”¨çš„ä¸€ä¸ªå‡½æ•°ã€‚åœ¨å…¬å¼ (1) ä¸­ï¼Œ`ReLU` æ˜¯ä¸€ä¸ªæ¿€æ´»å‡½æ•°ï¼ˆTransfromersåŸç‰ˆï¼‰ï¼Œå¯ä»¥æ›¿æ¢æˆå…¶ä»–çš„æ¿€æ´»å‡½æ•°ï¼Œæ¯”å¦‚ BERT å¼€å§‹ç”¨ `Gaussian Error Linear Unitï¼ŒGELU` æ¯”è¾ƒå¤šï¼Œéšåå°±æˆäº†æ¿€æ´»å‡½æ•°çš„ä¸»æµé€‰æ‹©ï¼Œä½†æ˜¯éšç€å¤§æ¨¡å‹çš„çˆ†ç«ä»¥åŠ PaLM æ¨¡å‹çš„å‘å¸ƒï¼Œå¤§å®¶å¼€å§‹æ…¢æ…¢ä½¿ç”¨ swishGLU ä½œä¸ºæ¿€æ´»å‡½æ•°ï¼Œå¹¶ä¸”ä½œä¸ºä¸€ä¸ªä¸»è¦çš„ä¼˜åŒ–ç‚¹ã€‚


å…·ä½“å¯ä»¥çœ‹ä¸‹é¢ä¸€æ®µä»£ç å³å¯æ¸…æ¥šçš„ç†è§£ FFN æ¨¡å‹æ˜¯ä»€ä¹ˆå®ç°çš„ã€‚
```python
class FeedForward(nn.Module):
    # å®é™…ä¸Šå°±æ˜¯ MLP
    def __init__(self, config):
        super().__init__()
        self.net = nn.Sequential(
            nn.Linear(config.n_embd, 4 * config.n_embd),
             # æ¿€æ´»å‡½æ•°
             nn.ReLU(),  
             #  å¯ä»¥æ›¿æ¢æˆ nn.GELU(),  
             #  ä½†æ˜¯ å¦‚æœæ˜¯ SwishGLU åˆ™å®ç°æ–¹å¼æœ‰æ‰€ä¸åŒï¼Œæ¥ä¸‹æ¥å°±ä¼šä»‹ç» swishGLU æ˜¯æ€ä¹ˆå®ç°çš„
            nn.Linear(4 * config.n_embd, config.n_embd),
            nn.Dropout(config.dropout)
        )
    
    def forward(self, x):
        return self.net(x)
```

## 2. å‡çº§ä¹‹è·¯

### 1. ReLU
ReLU æ·±åº¦å­¦ä¹ ä»¥æ¥æœ€å¸¸ç”¨çš„æ¿€æ´»å‡½æ•°ï¼Œå…¶å…¬å¼éå¸¸çš„ç®€å•ã€‚
$$ReLU(x) = max(0, x) \tag{2}$$

### 2. GELU
ä» GPTã€BERT ä»¥æ¥ï¼ŒGELU ä¼¼ä¹æˆäº†æ–°æ—¶ä»£å–ä»£ ReLU çš„æ¿€æ´»å‡½æ•°ï¼Œå…·ä½“å½¢å¼å¦‚ä¸‹ï¼š
$$
GELU(x) = x  P(X \le x) = x  \Phi(x)  \tag{3}
$$

å…¶ä¸­ $\Phi(x)$ æ˜¯æ ‡å‡†æ­£æ€åˆ†å¸ƒçš„ç´¯è®¡åˆ†å¸ƒå‡½æ•°ï¼Œå®šä¹‰ä¸º 
$$
\Phi(x) = \frac{1}{2}(1 + erf(\frac{x}{\sqrt{2}}))  \tag{4}
$$
è¿™é‡Œçš„ `erf` æ˜¯è¯¯å·®å‡½æ•° 
$$
erf(x) = \frac{2}{\sqrt{\pi}} \int_0^x e^{-t^2} dt  \tag{5}
$$

ä½†æ˜¯è¿™ä¸ªå‡½æ•°ç”±äºè®¡ç®—æˆæœ¬è¾ƒé«˜ï¼Œå› æ­¤æœ‰ä¸¤ä¸ªåˆç­‰å‡½æ•°ä½œä¸ºè¿‘ä¼¼è®¡ç®—ï¼ˆä½†ç›®å‰ã€2025å¹´1æœˆ27æ—¥ã€‘å…¶å®å¾ˆå¤šæ¡†æ¶å·²ç»å¯ä»¥ç²¾ç¡®è®¡ç®— erf å‡½æ•°ï¼‰ã€‚

è¿‘ä¼¼è®¡ç®—åˆ†æè¯¦ç»†å¯ä»¥å‚è§è‹ç¥çš„æ–‡ç« ï¼Œ[GELUçš„ä¸¤ä¸ªåˆç­‰å‡½æ•°è¿‘ä¼¼æ˜¯æ€ä¹ˆæ¥çš„](https://spaces.ac.cn/archives/7309)

### 3. SwishGLU
swishGLU æ˜¯ swish æ¿€æ´»å‡½æ•°å’Œ GLU é—¨æ§å•å…ƒçš„ç»“åˆä½“ï¼Œå› æ­¤éœ€è¦åˆ†åˆ«ä»‹ç»ä¸¤è€…çš„ä¸åŒã€‚

å…¶ä¸­éœ€è¦æ³¨æ„çš„æ˜¯ï¼šåœ¨ T5 å¼€å§‹ï¼Œå¾ˆå¤šæ¨¡å‹ï¼ˆæ¯”å¦‚ PaLM ï¼‰åœ¨FFNå±‚éƒ½ä¸ç”¨ bias äº†ï¼Œä¹Ÿå°±æ˜¯è¯´ FFNçš„å…¬å¼å˜æˆäº†
$$
FFN(x) = \text{ActiveFunction}(xW_1)W2 \tag{6}
$$

æ³¨æ„å…¬å¼ 6 å’Œå…¬å¼ 1 çš„åŒºåˆ«ï¼Œä¸€å…±æ²¡æœ‰ bias ä¸€ä¸ªæœ‰ biasï¼Œä½†å…·ä½“å¾—çœ‹ä¸åŒæ¨¡å‹çš„å®ç°ï¼Œå¹¶ä¸èƒ½ä¸€æ¦‚è€Œè®ºã€‚

#### 3.1 swish æ¿€æ´»å‡½æ•°
swish æ˜¯ä¸€ä¸ªéçº¿æ€§å‡½æ•°ï¼ˆæ¿€æ´»å‡½æ•°éƒ½æ˜¯å¦‚æ­¤ï¼Œç¬‘ğŸ¤£ï¼‰ï¼Œå…·ä½“å…¬å¼ä¸ºï¼š

$$
\text{Swish} = x \sigma(\beta x)  \tag{7}
$$
å…¶ä¸­ $\beta$ æ˜¯ä¸€ä¸ªè¶…å‚æ•°ï¼Œå½“ $\beta = 1$ æ—¶ï¼ŒSwish å°±å˜æˆäº† SiLU (Sigmoid Linear Unit)ï¼Œå¤§å¤šæ•°æ¡†æ¶çš„é»˜è®¤å®ç°ï¼ˆå¦‚ PyTorchã€TensorFlow çš„ `nn.SiLU()`ï¼‰ä½¿ç”¨çš„æ˜¯ $\beta = 1$ çš„å›ºå®šç‰ˆæœ¬ã€‚

å› æ­¤å¦‚æœé‡‡ç”¨ swish æ¿€æ´»å‡½æ•°ï¼ŒFFN çš„å…¬å¼å˜æˆäº†

$$
FFN(W_1, W_2, x) = \text{Swish}(xW_1)W2 \tag{6}
$$

å…±æœ‰ä¸¤ä¸ªå¯å­¦ä¹ çš„çŸ©é˜µï¼Œå…¶ä¸­ $w_1,(4, 4h)$ æ˜¯å‡ç»´çŸ©é˜µï¼Œ$w_2,(4h, h)$ æ˜¯é™ä½ç»´åº¦çš„çŸ©é˜µã€‚

#### 3.2 GLU é—¨æ§å•å…ƒ
GLUï¼ŒGated Linear Unitsï¼Œæ˜¯ä¸€ç§é—¨æ§ç»“æ„ï¼ˆæœ‰å‚æ•°ï¼Œå› æ­¤ç›¸å¯¹äºæ™®é€šçš„æ¿€æ´»å‡½æ•°å¤šäº†ä¸€ä¸ª `gate` çŸ©é˜µï¼‰ï¼Œé€šè¿‡ sigmoid æ§åˆ¶ä¸åŒç»´åº¦çš„æ¿€æ´»ã€‚å…¬å¼å¦‚ä¸‹[^1]ï¼š

$$
GLU(W, x, V, b, c) = (Wx + b) \otimes \text{sigmoid}(Vx + c)  \tag{7}
$$

è¿™é‡Œæ˜¯ä¸æ˜¯ç†Ÿæ‚‰ LSTM, GRU çš„åŒå­¦ä¸€ä¸‹å°±ç†è§£ï¼Œå…¶ä¸­éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ`b, c` å¯¹åº”çš„ bias ä¸æ˜¯å¿…é¡»çš„ã€‚

å¯¹æ¯”å…¬å¼ 7 å’Œå…¬å¼ 9ï¼Œå…¬å¼ 9 ä¸­çš„ $w_{up}$ å¯¹åº” å…¬å¼ 7 ä¸­çš„ $W$ï¼Œè€Œ $w_{gate}$ å¯¹åº”å…¬å¼ 7 ä¸­çš„ $V$ çŸ©é˜µã€‚


#### 3.3 swishGLU çš„è¡¨è¾¾å½¢å¼
è€Œ `swishGLU` å°±æ˜¯æŠŠé—¨æ§å‡½æ•°æ›¿æ¢æˆäº† `swish`ï¼Œå¹¶ä¸”å»é™¤æ‰äº† `bias` éƒ¨åˆ†ï¼Œå› æ­¤ä¸€å…±æœ‰ä¸‰ä¸ªå¯è®­ç»ƒçš„å‚æ•°çŸ©é˜µ, w1, w2, w3ã€‚

å› æ­¤æœ€ç»ˆçš„å…¬å¼è¡¨è¾¾ä¸ºï¼Œ

$$
FFN(W_1, W_2, W_3, x) = W_2 \cdot (W_1x \otimes \text{Swish}(W_3x))  \tag{8}
$$

è€Œæˆ‘ä»¬éƒ½çŸ¥é“ FFN æ˜¯ä¸€ä¸ªå‡é«˜ç»´åº¦ï¼Œç„¶åé™ä½ç»´åº¦çš„è¿‡ç¨‹ï¼Œå› æ­¤å¯ä»¥å†™æˆï¼ŒW2 æ˜¯ä¸€ä¸ªé™ä½ç»´åº¦çš„å‚æ•°ï¼ŒW1 æ˜¯å‡é«˜ç»´åº¦çš„è¿‡ç¨‹ï¼Œè€Œ W3 æ˜¯ä¸€ä¸ª Gate éœ€è¦ç”¨åˆ°çš„å‚æ•°çŸ©é˜µã€‚
$$
FFN(w_{up}, w_{down}, w_{gate}) = w_{down} \cdot (w_{up}x \otimes \text{Swish}(w_{gate}x))  \tag{9}
$$

é€šè¿‡è¿™ä¸ªå…¬å¼æ•´ä½“å°±éå¸¸çš„æ¸…æ™°ç†è§£ä½¿ç”¨ swishGLU çš„ FFNã€‚

è€Œæˆ‘ä»¬éƒ½çŸ¥é“åœ¨ basic ç‰ˆæœ¬çš„ FFNï¼Œè§å…¬å¼ï¼ˆ1ï¼‰ï¼Œ åªæœ‰ $w_{up} $ å’Œ $w_{down}$ åˆ†åˆ«æ˜¯ (h, 4h) å’Œï¼ˆ4h, hï¼‰ï¼Œå› æ­¤æ•´ä½“å‚æ•°æ˜¯ $8h^2$ã€‚

è€Œå…¬å¼9 ä¸­ï¼Œä¸€å…±æœ‰ä¸‰ä¸ªçŸ©é˜µï¼Œå¦‚æœæƒ³è¦å®ç°æ€»å‚æ•° $8h^2$ï¼Œé‚£ä¹ˆæ¯ä¸€ä¸ªå‚æ•°çŸ©é˜µçš„å¤§å°åº”è¯¥æ˜¯ $\frac{8h^2}{3}$ï¼Œå› æ­¤ $w_{up},w_{down}, w_{gate}$ çš„shapeåº”è¯¥æ˜¯ $(h, \frac{8h}{3})$ã€‚

å‡è®¾è¾“å…¥çš„ `hidden_dim` å¤§å°æ˜¯ `hidden_dim`ï¼Œé‚£ä¹ˆä¸­é—´å±‚ï¼ˆup åçš„ç»´åº¦ï¼‰å¤§å°æ˜¯ `mid_dim`ï¼Œ å…·ä½“è®¡ç®—é€»è¾‘å¦‚ä¸‹ï¼š
```python
mid_dim = int(8 * hidden_dim / 3)
# multiple_ofï¼šmake SwiGLU hidden layer size multiple of large power of 2
mid_dim = multiple_of * ((mid_dim + multiple_of - 1) // multiple_of)

# multiple_of ä¸€èˆ¬è®¾ç½®ä¸º 256ï¼Œ LLaMA å’Œ GPTç­‰æ¨¡å‹
```


æ³¨æ„ï¼Œåœ¨ LLM (å¤§è¯­è¨€æ¨¡å‹) æ¶æ„ä¸­ï¼Œmultiple_of æ˜¯ä¸€ä¸ªç”¨äºä¼˜åŒ–è®¡ç®—æ•ˆç‡çš„å‚æ•°ï¼Œé€šå¸¸è®¾ç½®ä¸º 256 æˆ–å…¶ä»– 2 çš„å¹‚æ¬¡æ–¹æ•°ï¼ˆå¦‚ 128ã€512 ç­‰ï¼‰ï¼Œæœ€ç»ˆè®© `mid_dim` è°ƒæ•´ä¸º `multiple_of` çš„æ•´æ•°å€ã€‚è¿™æ ·åšæœ‰å‡ ä¸ªåŸå› ï¼š
1. ç¡¬ä»¶ä¼˜åŒ–ï¼šç°ä»£ GPU/TPU åœ¨å¤„ç† 2 çš„å¹‚æ¬¡æ–¹å¤§å°çš„å¼ é‡æ—¶æ•ˆç‡æœ€é«˜
2. å†…å­˜å¯¹é½ï¼šç¡®ä¿å†…å­˜å¯¹é½å¯ä»¥æé«˜è®¡ç®—é€Ÿåº¦
3. å¹¶è¡Œè®¡ç®—æ•ˆç‡ï¼šæŸäº›å¹¶è¡Œè®¡ç®—æ“ä½œåœ¨å¤„ç†è§„æ•´çš„æ•°å­—æ—¶æ•ˆç‡æ›´é«˜


## 3. å¸¦æœ‰ swishGLU çš„ FFN ä»£ç å®ç°
```python
class FFNExpert(nn.Module):
    def __init__(self, hidden_dim, dropout):   # LLM è¿›åŒ–ä¹‹è·¯ï¼Œ FFN æ¿€æ´»å‡½æ•°ä» GELU -> SwishGLU
        super().__init__()  

        # æœ‰ä¸€ä¸ª magic number å«åš 8/3
        hidden_dim = hidden_dim
        # è¿™é‡Œå¯ä»¥è‡ªå·±å»ä¼˜åŒ–æˆ multiple_of çš„å€æ•°
        mid_dim = hidden_dim * 8 // 3

        self.up = nn.Linear(hidden_dim, mid_dim, bias=False)
        self.down = nn.Linear(mid_dim, hidden_dim, bias=False)
        self.gate = nn.Linear(hidden_dim, mid_dim, bias=False)

        self.dropout = nn.Dropout(dropout)

    def forward(self, x):
        out = self.dropout(
            self.down(
                # up ä¹‹åçš„ Shape æ˜¯(b, s, mid_dim)
                # gate å’Œ up ä¹‹åçš„Shapeéƒ½æ˜¯ (b, s, mid_dim)
                # ä¸¤è€…æ˜¯ element-wise ç›¸ä¹˜
                self.gate(x) * F.silu(self.up(x))
            )
        )
        return out
```


## å‚è€ƒ
- [GELUçš„ä¸¤ä¸ªåˆç­‰å‡½æ•°è¿‘ä¼¼æ˜¯æ€ä¹ˆæ¥çš„](https://kexue.fm/archives/7309)

[^1]: https://zhuanlan.zhihu.com/p/693332639


æœ€åæ¬¢è¿å…³æ³¨æˆ‘ï¼ŒåŸºæœ¬å…¨ç½‘åŒå [chaofaç”¨ä»£ç æ‰“ç‚¹é…±æ²¹](https://bruceyuan.com/)
- å…¬ä¼—å·ï¼š ![chaofaç”¨ä»£ç æ‰“ç‚¹é…±æ²¹](https://bruceyuan.com/llms-zero-to-hero/chaofa-wechat-official-account.png)
- [Bç«™-chaofaç”¨ä»£ç æ‰“ç‚¹é…±æ²¹](https://space.bilibili.com/12420432)
- [YouTube-chaofaç”¨ä»£ç æ‰“ç‚¹é…±æ²¹](https://www.youtube.com/@bbruceyuan)
- [chaofa çš„ notion ç®€ä»‹](https://chaofa.notion.site/11a569b3ecce49b2826d679f5e2fdb54)